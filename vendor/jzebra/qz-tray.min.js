'use strict';var qz=(function(){if(!Array.isArray){Array.isArray=function(arg){return Object.prototype.toString.call(arg)==='[object Array]'}}var _qz={DEBUG:false,log:{trace:function(){if(_qz.DEBUG){console.log.apply(console,arguments)}},info:function(){console.info.apply(console,arguments)},warn:function(){if(_qz.DEBUG){console.warn.apply(console,arguments)}},error:function(){console.error.apply(console,arguments)}},streams:{serial:'SERIAL',usb:'USB'},websocket:{connection:null,connectConfig:{host:"localhost",usingSecure:true,protocol:{secure:"wss://",insecure:"ws://"},port:{secure:[8181,8282,8383,8484],insecure:[8182,8283,8384,8485],usingIndex:0},keepAlive:60,retries:0,delay:0},setup:{findConnection:function(config,resolve,reject){var address;if(config.usingSecure){address=config.protocol.secure+config.host+":"+config.port.secure[config.port.usingIndex]}else{address=config.protocol.insecure+config.host+":"+config.port.insecure[config.port.usingIndex]}try{_qz.log.trace("Attempting connection",address);_qz.websocket.connection=new _qz.tools.ws(address)}catch(err){_qz.log.error(err)}if(_qz.websocket.connection!=null){_qz.websocket.connection.established=false;_qz.websocket.connection.onopen=function(evt){_qz.log.trace(evt);_qz.log.info("Established connection with QZ Tray on "+address);_qz.websocket.setup.openConnection({resolve:resolve,reject:reject});if(config.keepAlive>0){var interval=setInterval(function(){if(!qz.websocket.isActive()){clearInterval(interval);return}_qz.websocket.connection.send("ping")},config.keepAlive*1000)}};_qz.websocket.connection.onclose=function(){if(navigator.userAgent.indexOf('Safari')!=-1&&navigator.userAgent.indexOf('Chrome')==-1){_qz.websocket.connection.onerror()}};_qz.websocket.connection.onerror=function(evt){_qz.log.trace(evt);config.port.usingIndex++;if((config.usingSecure&&config.port.usingIndex>=config.port.secure.length)||(!config.usingSecure&&config.port.usingIndex>=config.port.insecure.length)){reject(new Error("Unable to establish connection with QZ"));return}_qz.websocket.setup.findConnection(config,resolve,reject)}}else{reject(new Error("Unable to establish connection with QZ"))}},openConnection:function(openPromise){_qz.websocket.connection.established=true;_qz.websocket.connection.onclose=function(evt){_qz.log.trace(evt);_qz.log.info("Closed connection with QZ Tray");if(_qz.websocket.connection.promise!=undefined){_qz.websocket.connection.promise.resolve()}_qz.websocket.callClose(evt);_qz.websocket.connection=null};_qz.websocket.connection.onerror=function(evt){_qz.websocket.callError(evt)};_qz.websocket.connection.sendData=function(obj){_qz.log.trace("Preparing object for websocket",obj);if(obj.timestamp==undefined){obj.timestamp=Date.now()}if(obj.promise!=undefined){obj.uid=_qz.websocket.setup.newUID();_qz.websocket.pendingCalls[obj.uid]=obj.promise}try{if(obj.call!=undefined&&obj.signature==undefined){var signObj={call:obj.call,params:obj.params,timestamp:obj.timestamp};_qz.security.callSign(_qz.tools.hash(_qz.tools.stringify(signObj))).then(function(signature){_qz.log.trace("Signature for call",signature);obj.signature=signature;_qz.signContent=undefined;_qz.websocket.connection.send(_qz.tools.stringify(obj))})}else{_qz.log.trace("Signature for call",obj.signature);_qz.websocket.connection.send(_qz.tools.stringify(obj))}}catch(err){_qz.log.error(err);if(obj.promise!=undefined){obj.promise.reject(err);delete _qz.websocket.pendingCalls[obj.uid]}}};_qz.websocket.connection.onmessage=function(evt){var returned=JSON.parse(evt.data);if(returned.uid==null){if(returned.type==null){_qz.websocket.connection.close(4003,"Connected to incompatible QZ Tray version")}else{if(returned.type==_qz.streams.serial){_qz.serial.callSerial(returned.key,returned.data)}else if(returned.type==_qz.streams.usb){_qz.usb.callUsb(returned.key,returned.data)}else{_qz.log.warn("Cannot determine stream type for callback",returned)}}return}_qz.log.trace("Received response from websocket",returned);var promise=_qz.websocket.pendingCalls[returned.uid];if(promise==undefined){_qz.log.warn('No promise found for returned response')}else{if(returned.error!=undefined){promise.reject(new Error(returned.error))}else{promise.resolve(returned.result)}}delete _qz.websocket.pendingCalls[returned.uid]};function sendCert(cert){if(cert===undefined){cert=null}_qz.websocket.connection.sendData({certificate:cert,promise:openPromise})}_qz.security.callCert().then(sendCert).catch(sendCert)},newUID:function(){var len=6;return(new Array(len+1).join("0")+(Math.random()*Math.pow(36,len)<<0).toString(36)).slice(-len)}},pendingCalls:{},errorCallbacks:[],callError:function(evt){if(Array.isArray(_qz.websocket.errorCallbacks)){for(var i=0;i<_qz.websocket.errorCallbacks.length;i++){_qz.websocket.errorCallbacks[i](evt)}}else{_qz.websocket.errorCallbacks(evt)}},closedCallbacks:[],callClose:function(evt){if(Array.isArray(_qz.websocket.closedCallbacks)){for(var i=0;i<_qz.websocket.closedCallbacks.length;i++){_qz.websocket.closedCallbacks[i](evt)}}else{_qz.websocket.closedCallbacks(evt)}}},printing:{defaultConfig:{colorType:'color',copies:1,jobName:null,density:0,duplex:false,interpolation:'bicubic',margins:0,orientation:null,paperThickness:null,printerTray:null,rotation:0,scaleContent:true,size:null,units:'in',altPrinting:false,encoding:null,endOfDoc:null,perSpool:1}},serial:{serialCallbacks:[],callSerial:function(port,output){if(Array.isArray(_qz.serial.serialCallbacks)){for(var i=0;i<_qz.serial.serialCallbacks.length;i++){_qz.serial.serialCallbacks[i](port,output)}}else{_qz.serial.serialCallbacks(port,output)}}},usb:{usbCallbacks:[],callUsb:function(keys,data){if(Array.isArray(_qz.usb.usbCallbacks)){for(var i=0;i<_qz.usb.usbCallbacks.length;i++){_qz.usb.usbCallbacks[i](keys,data)}}else{_qz.usb.usbCallbacks(keys,data)}}},security:{certPromise:function(resolve,reject){reject()},callCert:function(){return _qz.tools.promise(_qz.security.certPromise)},signaturePromise:function(){return function(resolve){resolve()}},callSign:function(toSign){return _qz.tools.promise(_qz.security.signaturePromise(toSign))}},tools:{promise:function(resolver){return new RSVP.Promise(resolver)},stringify:function(object){var pjson=Array.prototype.toJSON;delete Array.prototype.toJSON;var result=JSON.stringify(object);Array.prototype.toJSON=pjson;return result},hash:typeof Sha256!=='undefined'?Sha256.hash:null,ws:typeof WebSocket!=='undefined'?WebSocket:null,absolute:function(loc){if(document&&typeof document.createElement==='function'){var a=document.createElement("a");a.href=loc;return a.href}return loc},extend:function(target){if(typeof target!=='object'){target={}}for(var i=1;i<arguments.length;i++){var source=arguments[i];if(!source){continue}for(var key in source){if(source.hasOwnProperty(key)){if(target===source[key]){continue}if(source[key]&&source[key].constructor&&source[key].constructor===Object){var clone;if(Array.isArray(source[key])){clone=target[key]||[]}else{clone=target[key]||{}}target[key]=_qz.tools.extend(clone,source[key])}else if(source[key]!==undefined){target[key]=source[key]}}}}return target}}};function Config(printer,opts){this.setPrinter=function(newPrinter){if(typeof newPrinter==='string'){newPrinter={name:newPrinter}}this.printer=newPrinter};this.getPrinter=function(){return this.printer};this.reconfigure=function(newOpts){_qz.tools.extend(this.config,newOpts)};this.getOptions=function(){return this.config};this.setPrinter(printer);this.config=opts}Config.prototype.print=function(data){qz.print(this,data)};return{websocket:{isActive:function(){return _qz.websocket.connection!=null&&_qz.websocket.connection.established},connect:function(options){return _qz.tools.promise(function(resolve,reject){if(qz.websocket.isActive()){reject(new Error("An open connection with QZ Tray already exists"));return}if(!_qz.tools.ws){reject(new Error("WebSocket not supported by this browser"));return}if(!_qz.tools.ws.CLOSED||_qz.tools.ws.CLOSED==2){reject(new Error("Unsupported WebSocket version detected: HyBi-00/Hixie-76"));return}if(typeof location==='undefined'||location.protocol!=='https:'){if(options==undefined){options={}}options.usingSecure=false}var attempt=function(count){var nextAttempt=function(){if(count<options.retries){attempt(count+1)}else{reject.apply(null,arguments)}};var delayed=function(){var config=_qz.tools.extend({},_qz.websocket.connectConfig,options);_qz.websocket.setup.findConnection(config,resolve,nextAttempt)};if(count==0){delayed()}else{setTimeout(delayed,options.delay*1000)}};attempt(0)})},disconnect:function(){return _qz.tools.promise(function(resolve,reject){if(qz.websocket.isActive()){_qz.websocket.connection.close();_qz.websocket.connection.promise={resolve:resolve,reject:reject}}else{reject(new Error("No open connection with QZ Tray"))}})},setErrorCallbacks:function(calls){_qz.websocket.errorCallbacks=calls},setClosedCallbacks:function(calls){_qz.websocket.closedCallbacks=calls},getNetworkInfo:function(){return _qz.tools.promise(function(resolve,reject){var msg={call:'websocket.getNetworkInfo',promise:{resolve:resolve,reject:reject}};_qz.websocket.connection.sendData(msg)})}},printers:{getDefault:function(){return _qz.tools.promise(function(resolve,reject){var msg={call:'printers.getDefault',promise:{resolve:resolve,reject:reject}};_qz.websocket.connection.sendData(msg)})},find:function(query){return _qz.tools.promise(function(resolve,reject){var msg={call:'printers.find',promise:{resolve:resolve,reject:reject},params:{query:query}};_qz.websocket.connection.sendData(msg)})}},configs:{setDefaults:function(options){_qz.tools.extend(_qz.printing.defaultConfig,options)},create:function(printer,options){var myOpts=_qz.tools.extend({},_qz.printing.defaultConfig,options);return new Config(printer,myOpts)}},print:function(config,data,signature,signingTimestamp){for(var i=0;i<data.length;i++){if(typeof data[i]==='object'){if((!data[i].format&&data[i].type.toUpperCase()!=='RAW')||(data[i].format&&(data[i].format.toUpperCase()==='FILE'||data[i].format.toUpperCase()==='IMAGE'||data[i].format.toUpperCase()==='XML'))){data[i].data=_qz.tools.absolute(data[i].data)}}}return _qz.tools.promise(function(resolve,reject){var msg={call:'print',promise:{resolve:resolve,reject:reject},params:{printer:config.getPrinter(),options:config.getOptions(),data:data},signature:signature,timestamp:signingTimestamp};_qz.websocket.connection.sendData(msg)})},serial:{findPorts:function(){return _qz.tools.promise(function(resolve,reject){var msg={call:'serial.findPorts',promise:{resolve:resolve,reject:reject}};_qz.websocket.connection.sendData(msg)})},setSerialCallbacks:function(calls){_qz.serial.serialCallbacks=calls},openPort:function(port,bounds){return _qz.tools.promise(function(resolve,reject){var msg={call:'serial.openPort',promise:{resolve:resolve,reject:reject},params:{port:port,bounds:bounds}};_qz.websocket.connection.sendData(msg)})},sendData:function(port,data,properties){return _qz.tools.promise(function(resolve,reject){var msg={call:'serial.sendData',promise:{resolve:resolve,reject:reject},params:{port:port,data:data,properties:properties}};_qz.websocket.connection.sendData(msg)})},closePort:function(port){return _qz.tools.promise(function(resolve,reject){var msg={call:'serial.closePort',promise:{resolve:resolve,reject:reject},params:{port:port}};_qz.websocket.connection.sendData(msg)})}},usb:{listDevices:function(includeHubs){return _qz.tools.promise(function(resolve,reject){var msg={call:'usb.listDevices',promise:{resolve:resolve,reject:reject},params:{includeHubs:includeHubs}};_qz.websocket.connection.sendData(msg)})},listInterfaces:function(vendorId,productId){return _qz.tools.promise(function(resolve,reject){var msg={call:'usb.listInterfaces',promise:{resolve:resolve,reject:reject},params:{vendorId:vendorId,productId:productId}};_qz.websocket.connection.sendData(msg)})},listEndpoints:function(vendorId,productId,iface){return _qz.tools.promise(function(resolve,reject){var msg={call:'usb.listEndpoints',promise:{resolve:resolve,reject:reject},params:{vendorId:vendorId,productId:productId,interface:iface}};_qz.websocket.connection.sendData(msg)})},setUsbCallbacks:function(calls){_qz.usb.usbCallbacks=calls},claimDevice:function(vendorId,productId,iface){return _qz.tools.promise(function(resolve,reject){var msg={call:'usb.claimDevice',promise:{resolve:resolve,reject:reject},params:{vendorId:vendorId,productId:productId,interface:iface}};_qz.websocket.connection.sendData(msg)})},sendData:function(vendorId,productId,endpoint,data){return _qz.tools.promise(function(resolve,reject){var msg={call:'usb.sendData',promise:{resolve:resolve,reject:reject},params:{vendorId:vendorId,productId:productId,endpoint:endpoint,data:data}};_qz.websocket.connection.sendData(msg)})},readData:function(vendorId,productId,endpoint,responseSize){return _qz.tools.promise(function(resolve,reject){var msg={call:'usb.readData',promise:{resolve:resolve,reject:reject},params:{vendorId:vendorId,productId:productId,endpoint:endpoint,responseSize:responseSize}};_qz.websocket.connection.sendData(msg)})},openStream:function(vendorId,productId,endpoint,responseSize,interval){return _qz.tools.promise(function(resolve,reject){var msg={call:'usb.openStream',promise:{resolve:resolve,reject:reject},params:{vendorId:vendorId,productId:productId,endpoint:endpoint,responseSize:responseSize,interval:interval}};_qz.websocket.connection.sendData(msg)})},closeStream:function(vendorId,productId,endpoint){return _qz.tools.promise(function(resolve,reject){var msg={call:'usb.closeStream',promise:{resolve:resolve,reject:reject},params:{vendorId:vendorId,productId:productId,endpoint:endpoint}};_qz.websocket.connection.sendData(msg)})},releaseDevice:function(vendorId,productId){return _qz.tools.promise(function(resolve,reject){var msg={call:'usb.releaseDevice',promise:{resolve:resolve,reject:reject},params:{vendorId:vendorId,productId:productId}};_qz.websocket.connection.sendData(msg)})}},security:{setCertificatePromise:function(promiseCall){_qz.security.certPromise=promiseCall},setSignaturePromise:function(promiseGen){_qz.security.signaturePromise=promiseGen}},api:{showDebug:function(show){_qz.DEBUG=show},getVersion:function(){return _qz.tools.promise(function(resolve,reject){var msg={call:'getVersion',promise:{resolve:resolve,reject:reject}};_qz.websocket.connection.sendData(msg)})},setPromiseType:function(promiser){_qz.tools.promise=promiser},setSha256Type:function(hasher){_qz.tools.hash=hasher},setWebSocketType:function(ws){_qz.tools.ws=ws}}}})();(function(){if(typeof define==='function'&&define.amd){define(qz)}else if(typeof exports==='object'){module.exports=qz}else{window.qz=qz}})();